Ext.getCmp('viewport-east').setVisible(false);

var center = Ext.getCmp('viewport-center');
center.removeAll();

var panel = new Ext.TabPanel({
    id: 'page-edit-tab',
    resizeTabs: false,
    minTabWidth: 115,
    tabWidth:135,
    enableTabScroll:true,
    defaults: {
        autoScroll:true
    },
    tabPosition: 'top'
});

center.add(panel);

var reloadTreeByArt = function(id) {
        var tree = Ext.getCmp('pageview-cattree'); 
        
	var node = tree.getNodeById("idart-" + id);
        
	tree.getLoader().load(node.parentNode, function(n) {
		n.expand(false, false, function() {
			tree.getNodeById(node.attributes.id).expand(false, false);
		});
	});
}

var setUnpublished = function() {
    var b = Ext.getCmp('publish-button');
    b.setIconClass('page-unpublished');
    b.setDisabled(false);
}

var reloadPageTreeNode_Article = function(idart) {
    var tree = Ext.getCmp('pageview-cattree');
    
    var node = tree.getNodeById('idart-' + idart);

    tree.getLoader().load(node.parentNode, function(n) {
        n.expand(false, false, function() {
            tree.getNodeById(node.attributes.id).expand(false, false);
        });
    });
}

var onlineBtn = new Ext.Button({
    tooltip: '<?php echo ($this->art->online ? Aitsu_Translate :: translate('Set offline') : Aitsu_Translate :: translate('Set online')); ?>',
    iconCls: '<?php echo ($this->art->online ? 'page-online' : 'page-offline'); ?>',
    handler: function(b, e) {
        Ext.Ajax.request({
            url: '<?php echo $this->url(array('controller' => 'data', 'action' => 'toggleonline'), 'default'); ?>',
            success: function(response, opts) {
                var rsp = Ext.decode(response.responseText);
                reloadPageTreeNode_Article(<?php echo $this->idart; ?>);
                if (rsp.online == 1) {
                    b.setIconClass('page-online');
                    b.setTooltip('<?php echo Aitsu_Translate :: translate('Set offline'); ?>');
                } else {
                    b.setIconClass('page-offline');
                    b.setTooltip('<?php echo Aitsu_Translate :: translate('Set online'); ?>');
                }
                reloadTreeByArt(<?php echo $this->idart; ?>);
                setUnpublished();
            },
            params: {
                idart: <?php echo $this->idart; ?>
            }
        });
    }
});

var publishBtn = new Ext.Button({
    id: 'publish-button',
    tooltip: '<?php echo Aitsu_Translate :: translate('Publish'); ?>',
    iconCls: '<?php echo ($this->art->ispublished ? 'page-published' : 'page-unpublished'); ?>',
    disabled: <?php echo ($this->art->ispublished ? 'true' : 'false'); ?>,
    handler: function(b, e) {
        Ext.Ajax.request({
            url: '<?php echo $this->url(array('controller' => 'data', 'action' => 'startpublishing'), 'default'); ?>',
            success: function(response, opts) {
                b.setIconClass('page-published');
            },
            params: {
                idart: <?php echo $this->idart; ?>
            }
        });
    }
});

<?php if ($this->hidePublishing) : ?>
publishBtn.hide();
<?php endif; ?>

Ext.getCmp('page-edit-tab').add({
    title: '<?php echo Aitsu_Translate :: translate('Meta data'); ?>',
    layout: 'border',
    items: [{
        region: 'center',
        id: 'page-edit-overview-center',
        split: true,
        layout: 'fit'
    }, {
        region: 'east',
        split: true,
        width: 350,
        layout: 'fit',
        items: new Ext.Panel({
            layout: 'accordion',
            border: false,
            id: 'page-plugin-accordion',
            layoutConfig: {
                titleCollapse: true,
                hideCollapseTool: true,
                animate: true
            },
            tbar: {
                items: [
                    onlineBtn,
                    publishBtn
                ]
            }
        })
    }]
});